/* 
 * Mach Operating System
 * Copyright (c) 1991 Carnegie-Mellon University
 * Copyright (c) 1990 Carnegie-Mellon University
 * Copyright (c) 1989 Carnegie-Mellon University
 * Copyright (c) 1988 Carnegie-Mellon University
 * All rights reserved.  The CMU software License Agreement specifies
 * the terms and conditions for use and redistribution.
 */
/*
 * HISTORY
 */

/*
 *	Apple Macintosh II Mach (macmach)
 *
 *	File: emul/patches/emul.c
 *	Author: David E. Bohman II (CMU macmach)
 */

#include <mach.h>

#include "mac.h"

extern port_t	kernel_request_port;

extern		OSvec[], TBOXvec[], RESETvec[];

extern		InsTime(), PrimeTime(), RmvTime();
extern		SwapMMUMode();
extern		ReadDateTime(), SetDateTime();

/*
 * Support for A-line trap emulation
 */

/*
 * Operating System trap
 * table.  (256 entries)
 */
int (*os_traps[])() = {
  0, 0, 0, 0, /* 00 */
  0, 0, 0, 0, /* 04 */
  0, 0, 0, 0, /* 08 */
  0, 0, 0, 0, /* 0c */
  0, 0, 0, 0, /* 10 */
  0, 0, 0, 0, /* 14 */
  0, 0, 0, 0, /* 18 */
  0, 0, 0, 0, /* 1c */
  0, 0, 0, 0, /* 20 */
  0, 0, 0, 0, /* 24 */
  0, 0, 0, 0, /* 28 */
  0, 0, 0, 0, /* 2c */
  0, 0, 0, 0, /* 30 */
  0, 0, 0, 0, /* 34 */
  0, ReadDateTime, SetDateTime, 0, /* 38 */
  0, 0, 0, 0, /* 3c */
  0, 0, 0, 0, /* 40 */
  0, 0, 0, 0, /* 44 */
  0, 0, 0, 0, /* 48 */
  0, 0, 0, 0, /* 4c */
  0, 0, 0, 0, /* 50 */
  0, 0, 0, 0, /* 54 */
  InsTime, RmvTime, PrimeTime, 0, /* 58 */
  0, SwapMMUMode, 0, 0, /* 5c */
  0, 0, 0, 0, /* 60 */
  0, 0, 0, 0, /* 64 */
  0, 0, 0, 0, /* 68 */
  0, 0, 0, 0, /* 6c */
  0, 0, 0, 0, /* 70 */
  0, 0, 0, 0, /* 74 */
  0, 0, 0, 0, /* 78 */
  0, 0, 0, 0, /* 7c */
  0, 0, 0, 0, /* 80 */
  0, 0, 0, 0, /* 84 */
  0, 0, 0, 0, /* 88 */
  0, 0, 0, 0, /* 8c */
  0, 0, 0, 0, /* 90 */
  0, 0, 0, 0, /* 94 */
  0, 0, 0, 0, /* 98 */
  0, 0, 0, 0, /* 9c */
  0, 0, 0, 0, /* a0 */
  0, 0, 0, 0, /* a4 */
  0, 0, 0, 0, /* a8 */
  0, 0, 0, 0, /* ac */
  0, 0, 0, 0, /* b0 */
  0, 0, 0, 0, /* b4 */
  0, 0, 0, 0, /* b8 */
  0, 0, 0, 0, /* bc */
  0, 0, 0, 0, /* c0 */
  0, 0, 0, 0, /* c4 */
  0, 0, 0, 0, /* c8 */
  0, 0, 0, 0, /* cc */
  0, 0, 0, 0, /* d0 */
  0, 0, 0, 0, /* d4 */
  0, 0, 0, 0, /* d8 */
  0, 0, 0, 0, /* dc */
  0, 0, 0, 0, /* e0 */
  0, 0, 0, 0, /* e4 */
  0, 0, 0, 0, /* e8 */
  0, 0, 0, 0, /* ec */
  0, 0, 0, 0, /* f0 */
  0, 0, 0, 0, /* f4 */
  0, 0, 0, 0, /* f8 */
  0, 0, 0, 0, /* fc */
};

/*
 * ToolBox trap
 * table. (1024 entries)
 *
 * None are implemented (yet?)
 */
int (*tbox_traps[])() = {
  0, 0, 0, 0, /* 000 */
  0, 0, 0, 0, /* 004 */
  0, 0, 0, 0, /* 008 */
  0, 0, 0, 0, /* 00c */
  0, 0, 0, 0, /* 010 */
  0, 0, 0, 0, /* 014 */
  0, 0, 0, 0, /* 018 */
  0, 0, 0, 0, /* 01c */
  0, 0, 0, 0, /* 020 */
  0, 0, 0, 0, /* 024 */
  0, 0, 0, 0, /* 028 */
  0, 0, 0, 0, /* 02c */
  0, 0, 0, 0, /* 030 */
  0, 0, 0, 0, /* 034 */
  0, 0, 0, 0, /* 038 */
  0, 0, 0, 0, /* 03c */
  0, 0, 0, 0, /* 040 */
  0, 0, 0, 0, /* 044 */
  0, 0, 0, 0, /* 048 */
  0, 0, 0, 0, /* 04c */
  0, 0, 0, 0, /* 050 */
  0, 0, 0, 0, /* 054 */
  0, 0, 0, 0, /* 058 */
  0, 0, 0, 0, /* 05c */
  0, 0, 0, 0, /* 060 */
  0, 0, 0, 0, /* 064 */
  0, 0, 0, 0, /* 068 */
  0, 0, 0, 0, /* 06c */
  0, 0, 0, 0, /* 070 */
  0, 0, 0, 0, /* 074 */
  0, 0, 0, 0, /* 078 */
  0, 0, 0, 0, /* 07c */
  0, 0, 0, 0, /* 080 */
  0, 0, 0, 0, /* 084 */
  0, 0, 0, 0, /* 088 */
  0, 0, 0, 0, /* 08c */
  0, 0, 0, 0, /* 090 */
  0, 0, 0, 0, /* 094 */
  0, 0, 0, 0, /* 098 */
  0, 0, 0, 0, /* 09c */
  0, 0, 0, 0, /* 0a0 */
  0, 0, 0, 0, /* 0a4 */
  0, 0, 0, 0, /* 0a8 */
  0, 0, 0, 0, /* 0ac */
  0, 0, 0, 0, /* 0b0 */
  0, 0, 0, 0, /* 0b4 */
  0, 0, 0, 0, /* 0b8 */
  0, 0, 0, 0, /* 0bc */
  0, 0, 0, 0, /* 0c0 */
  0, 0, 0, 0, /* 0c4 */
  0, 0, 0, 0, /* 0c8 */
  0, 0, 0, 0, /* 0cc */
  0, 0, 0, 0, /* 0d0 */
  0, 0, 0, 0, /* 0d4 */
  0, 0, 0, 0, /* 0d8 */
  0, 0, 0, 0, /* 0dc */
  0, 0, 0, 0, /* 0e0 */
  0, 0, 0, 0, /* 0e4 */
  0, 0, 0, 0, /* 0e8 */
  0, 0, 0, 0, /* 0ec */
  0, 0, 0, 0, /* 0f0 */
  0, 0, 0, 0, /* 0f4 */
  0, 0, 0, 0, /* 0f8 */
  0, 0, 0, 0, /* 0fc */
  0, 0, 0, 0, /* 100 */
  0, 0, 0, 0, /* 104 */
  0, 0, 0, 0, /* 108 */
  0, 0, 0, 0, /* 10c */
  0, 0, 0, 0, /* 110 */
  0, 0, 0, 0, /* 114 */
  0, 0, 0, 0, /* 118 */
  0, 0, 0, 0, /* 11c */
  0, 0, 0, 0, /* 120 */
  0, 0, 0, 0, /* 124 */
  0, 0, 0, 0, /* 128 */
  0, 0, 0, 0, /* 12c */
  0, 0, 0, 0, /* 130 */
  0, 0, 0, 0, /* 134 */
  0, 0, 0, 0, /* 138 */
  0, 0, 0, 0, /* 13c */
  0, 0, 0, 0, /* 140 */
  0, 0, 0, 0, /* 144 */
  0, 0, 0, 0, /* 148 */
  0, 0, 0, 0, /* 14c */
  0, 0, 0, 0, /* 150 */
  0, 0, 0, 0, /* 154 */
  0, 0, 0, 0, /* 158 */
  0, 0, 0, 0, /* 15c */
  0, 0, 0, 0, /* 160 */
  0, 0, 0, 0, /* 164 */
  0, 0, 0, 0, /* 168 */
  0, 0, 0, 0, /* 16c */
  0, 0, 0, 0, /* 170 */
  0, 0, 0, 0, /* 174 */
  0, 0, 0, 0, /* 178 */
  0, 0, 0, 0, /* 17c */
  0, 0, 0, 0, /* 180 */
  0, 0, 0, 0, /* 184 */
  0, 0, 0, 0, /* 188 */
  0, 0, 0, 0, /* 18c */
  0, 0, 0, 0, /* 190 */
  0, 0, 0, 0, /* 194 */
  0, 0, 0, 0, /* 198 */
  0, 0, 0, 0, /* 19c */
  0, 0, 0, 0, /* 1a0 */
  0, 0, 0, 0, /* 1a4 */
  0, 0, 0, 0, /* 1a8 */
  0, 0, 0, 0, /* 1ac */
  0, 0, 0, 0, /* 1b0 */
  0, 0, 0, 0, /* 1b4 */
  0, 0, 0, 0, /* 1b8 */
  0, 0, 0, 0, /* 1bc */
  0, 0, 0, 0, /* 1c0 */
  0, 0, 0, 0, /* 1c4 */
  0, 0, 0, 0, /* 1c8 */
  0, 0, 0, 0, /* 1cc */
  0, 0, 0, 0, /* 1d0 */
  0, 0, 0, 0, /* 1d4 */
  0, 0, 0, 0, /* 1d8 */
  0, 0, 0, 0, /* 1dc */
  0, 0, 0, 0, /* 1e0 */
  0, 0, 0, 0, /* 1e4 */
  0, 0, 0, 0, /* 1e8 */
  0, 0, 0, 0, /* 1ec */
  0, 0, 0, 0, /* 1f0 */
  0, 0, 0, 0, /* 1f4 */
  0, 0, 0, 0, /* 1f8 */
  0, 0, 0, 0, /* 1fc */
  0, 0, 0, 0, /* 200 */
  0, 0, 0, 0, /* 204 */
  0, 0, 0, 0, /* 208 */
  0, 0, 0, 0, /* 20c */
  0, 0, 0, 0, /* 210 */
  0, 0, 0, 0, /* 214 */
  0, 0, 0, 0, /* 218 */
  0, 0, 0, 0, /* 21c */
  0, 0, 0, 0, /* 220 */
  0, 0, 0, 0, /* 224 */
  0, 0, 0, 0, /* 228 */
  0, 0, 0, 0, /* 22c */
  0, 0, 0, 0, /* 230 */
  0, 0, 0, 0, /* 234 */
  0, 0, 0, 0, /* 238 */
  0, 0, 0, 0, /* 23c */
  0, 0, 0, 0, /* 240 */
  0, 0, 0, 0, /* 244 */
  0, 0, 0, 0, /* 248 */
  0, 0, 0, 0, /* 24c */
  0, 0, 0, 0, /* 250 */
  0, 0, 0, 0, /* 254 */
  0, 0, 0, 0, /* 258 */
  0, 0, 0, 0, /* 25c */
  0, 0, 0, 0, /* 260 */
  0, 0, 0, 0, /* 264 */
  0, 0, 0, 0, /* 268 */
  0, 0, 0, 0, /* 26c */
  0, 0, 0, 0, /* 270 */
  0, 0, 0, 0, /* 274 */
  0, 0, 0, 0, /* 278 */
  0, 0, 0, 0, /* 27c */
  0, 0, 0, 0, /* 280 */
  0, 0, 0, 0, /* 284 */
  0, 0, 0, 0, /* 288 */
  0, 0, 0, 0, /* 28c */
  0, 0, 0, 0, /* 290 */
  0, 0, 0, 0, /* 294 */
  0, 0, 0, 0, /* 298 */
  0, 0, 0, 0, /* 29c */
  0, 0, 0, 0, /* 2a0 */
  0, 0, 0, 0, /* 2a4 */
  0, 0, 0, 0, /* 2a8 */
  0, 0, 0, 0, /* 2ac */
  0, 0, 0, 0, /* 2b0 */
  0, 0, 0, 0, /* 2b4 */
  0, 0, 0, 0, /* 2b8 */
  0, 0, 0, 0, /* 2bc */
  0, 0, 0, 0, /* 2c0 */
  0, 0, 0, 0, /* 2c4 */
  0, 0, 0, 0, /* 2c8 */
  0, 0, 0, 0, /* 2cc */
  0, 0, 0, 0, /* 2d0 */
  0, 0, 0, 0, /* 2d4 */
  0, 0, 0, 0, /* 2d8 */
  0, 0, 0, 0, /* 2dc */
  0, 0, 0, 0, /* 2e0 */
  0, 0, 0, 0, /* 2e4 */
  0, 0, 0, 0, /* 2e8 */
  0, 0, 0, 0, /* 2ec */
  0, 0, 0, 0, /* 2f0 */
  0, 0, 0, 0, /* 2f4 */
  0, 0, 0, 0, /* 2f8 */
  0, 0, 0, 0, /* 2fc */
  0, 0, 0, 0, /* 300 */
  0, 0, 0, 0, /* 304 */
  0, 0, 0, 0, /* 308 */
  0, 0, 0, 0, /* 30c */
  0, 0, 0, 0, /* 310 */
  0, 0, 0, 0, /* 314 */
  0, 0, 0, 0, /* 318 */
  0, 0, 0, 0, /* 31c */
  0, 0, 0, 0, /* 320 */
  0, 0, 0, 0, /* 324 */
  0, 0, 0, 0, /* 328 */
  0, 0, 0, 0, /* 32c */
  0, 0, 0, 0, /* 330 */
  0, 0, 0, 0, /* 334 */
  0, 0, 0, 0, /* 338 */
  0, 0, 0, 0, /* 33c */
  0, 0, 0, 0, /* 340 */
  0, 0, 0, 0, /* 344 */
  0, 0, 0, 0, /* 348 */
  0, 0, 0, 0, /* 34c */
  0, 0, 0, 0, /* 350 */
  0, 0, 0, 0, /* 354 */
  0, 0, 0, 0, /* 358 */
  0, 0, 0, 0, /* 35c */
  0, 0, 0, 0, /* 360 */
  0, 0, 0, 0, /* 364 */
  0, 0, 0, 0, /* 368 */
  0, 0, 0, 0, /* 36c */
  0, 0, 0, 0, /* 370 */
  0, 0, 0, 0, /* 374 */
  0, 0, 0, 0, /* 378 */
  0, 0, 0, 0, /* 37c */
  0, 0, 0, 0, /* 380 */
  0, 0, 0, 0, /* 384 */
  0, 0, 0, 0, /* 388 */
  0, 0, 0, 0, /* 38c */
  0, 0, 0, 0, /* 390 */
  0, 0, 0, 0, /* 394 */
  0, 0, 0, 0, /* 398 */
  0, 0, 0, 0, /* 39c */
  0, 0, 0, 0, /* 3a0 */
  0, 0, 0, 0, /* 3a4 */
  0, 0, 0, 0, /* 3a8 */
  0, 0, 0, 0, /* 3ac */
  0, 0, 0, 0, /* 3b0 */
  0, 0, 0, 0, /* 3b4 */
  0, 0, 0, 0, /* 3b8 */
  0, 0, 0, 0, /* 3bc */
  0, 0, 0, 0, /* 3c0 */
  0, 0, 0, 0, /* 3c4 */
  0, 0, 0, 0, /* 3c8 */
  0, 0, 0, 0, /* 3cc */
  0, 0, 0, 0, /* 3d0 */
  0, 0, 0, 0, /* 3d4 */
  0, 0, 0, 0, /* 3d8 */
  0, 0, 0, 0, /* 3dc */
  0, 0, 0, 0, /* 3e0 */
  0, 0, 0, 0, /* 3e4 */
  0, 0, 0, 0, /* 3e8 */
  0, 0, 0, 0, /* 3ec */
  0, 0, 0, 0, /* 3f0 */
  0, 0, 0, 0, /* 3f4 */
  0, 0, 0, 0, /* 3f8 */
  0, 0, 0, 0, /* 3fc */
};

kern_return_t
emul_init()
{
    mac_os_map_t	os_map;
    mac_tbox_map_t	tbox_map;

    emul_init_os(os_map);

    emul_init_tbox(tbox_map);

    return (mac_emulate(kernel_request_port,
			(vm_address_t) RESETvec,
			(vm_address_t) OSvec, os_map,
			(vm_address_t) TBOXvec, tbox_map));
}

emul_init_os(os_map)
mac_os_map_t	os_map;
{
    register	i, byte, bit;

    bzero(os_map, sizeof (mac_os_map_t));

    for (i = 0; i < 256; i++)
	if (os_traps[i] != 0) {
	    byte = i / 8;
	    bit = i % 8;
	    asm volatile("bfset	%0{%1:#1}" :
			 "=m" (os_map[byte]) :
			 "d" (bit));
	}
}

emul_init_tbox(tbox_map)
mac_tbox_map_t	tbox_map;
{
    register	i, byte, bit;

    bzero(tbox_map, sizeof (mac_tbox_map_t));

    for (i = 0; i < 1024; i++)
	if (tbox_traps[i] != 0) {
	    byte = i / 8;
	    bit = i % 8;
	    asm volatile("bfset	%0{%1:#1}" :
			 "=m" (tbox_map[byte]) :
			 "d" (bit));
	}
}
